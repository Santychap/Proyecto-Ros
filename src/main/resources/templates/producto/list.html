<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="layout/base :: layout('Gestión de Productos', ~{::section})">

<section th:fragment="section">

  <!-- Encabezado de página -->
  <div class="page-header">
    <div class="btn-group-header">
      <h1><i class="bi bi-box me-2"></i>Gestión de Productos</h1>
      <a th:href="@{/productos/new}" class="btn btn-success">
        <i class="bi bi-plus-circle me-2"></i>Nuevo Producto
      </a>
    </div>
  </div>

  <!-- Sección de contenido -->
  <div class="content-section">
    <!-- Estadísticas rápidas -->
    <div class="row mb-4">
      <div class="col-md-4 col-sm-6 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title text-warning">Total Productos</h5>
            <h3 class="text-info" th:text="${#lists.size(productos)}">0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-4 col-sm-6 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title text-warning">Precio Promedio</h5>
            <h3 class="text-success">$<span th:text="${#aggregates.avg(productos.![precio]) != null ? #numbers.formatDecimal(#aggregates.avg(productos.![precio]), 1, 2) : '0.00'}">0.00</span></h3>
          </div>
        </div>
      </div>
      <div class="col-md-4 col-sm-6 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title text-warning">Categorías</h5>
            <h3 class="text-warning" th:text="${#sets.size(#sets.toSet(productos.![categoriaId]))}">0</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros de búsqueda -->
    <div class="card mb-4">
      <div class="card-header">
        <i class="bi bi-search me-2"></i>Filtros de Búsqueda
      </div>
      <div class="card-body">
        <form th:action="@{/productos}" method="get" class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nombre del Producto</label>
            <input class="form-control" type="text" name="nombre" 
                   placeholder="Buscar por nombre..." th:value="${param.nombre}" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Acción</label>
            <div class="d-grid">
              <button class="btn btn-primary" type="submit">
                <i class="bi bi-search me-2"></i>Buscar
              </button>
            </div>
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <div class="d-grid">
              <a th:href="@{/productos}" class="btn btn-secondary">
                <i class="bi bi-arrow-clockwise me-2"></i>Limpiar
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Tabla de productos -->
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
        <tr>
          <th><i class="bi bi-hash me-1"></i>ID</th>
          <th><i class="bi bi-tag me-1"></i>Nombre</th>
          <th><i class="bi bi-file-text me-1"></i>Descripción</th>
          <th><i class="bi bi-currency-dollar me-1"></i>Precio</th>
          <th><i class="bi bi-collection me-1"></i>Categoría</th>
          <th><i class="bi bi-calendar me-1"></i>Fecha Creación</th>
          <th><i class="bi bi-gear me-1"></i>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="producto : ${productos}">
          <td><strong th:text="${producto.idProducto}"></strong></td>
          <td>
            <div class="d-flex align-items-center">
              <img th:if="${producto.imagenUrl != null and !producto.imagenUrl.isEmpty()}" 
                   th:src="${producto.imagenUrl}" 
                   alt="Imagen del producto" 
                   class="me-2" 
                   style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px;" />
              <i th:unless="${producto.imagenUrl != null and !producto.imagenUrl.isEmpty()}" 
                 class="bi bi-box me-2 text-warning"></i>
              <span th:text="${producto.nombre}"></span>
            </div>
          </td>
          <td>
            <span class="text-muted" th:text="${#strings.abbreviate(producto.descripcion, 40)}"
                  th:title="${producto.descripcion}"></span>
          </td>
          <td>
            <span class="badge bg-success fs-6" th:text="'$' + ${#numbers.formatDecimal(producto.precio, 1, 2)}"></span>
          </td>
          <td>
            <span class="badge bg-info" th:text="'Cat. ' + ${producto.categoriaId}"></span>
          </td>
          <td>
            <small th:text="${producto.createdAt != null ? #dates.format(producto.createdAt, 'dd/MM/yyyy') : 'N/A'}"></small>
          </td>
          <td>
            <div class="btn-group-actions">
              <a href="/menu" class="btn btn-info btn-sm" title="Ver en menú público">
                <i class="bi bi-eye"></i>
                <span class="d-none d-md-inline ms-1">Ver Menú</span>
              </a>
              <a th:href="@{'/productos/edit/' + ${producto.idProducto}}" class="btn btn-warning btn-sm" title="Editar producto">
                <i class="bi bi-pencil-square"></i>
                <span class="d-none d-md-inline ms-1">Editar</span>
              </a>
              <form th:action="@{'/productos/delete/' + ${producto.idProducto}}" method="post" style="display:inline"
                    onsubmit="return confirm('¿Está seguro de eliminar este producto?');">
                <button type="submit" class="btn btn-danger btn-sm" title="Eliminar producto">
                  <i class="bi bi-trash"></i>
                  <span class="d-none d-md-inline ms-1">Eliminar</span>
                </button>
              </form>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Mensaje si no hay productos -->
    <div th:if="${#lists.isEmpty(productos)}" class="text-center py-5">
      <i class="bi bi-box display-1 text-muted"></i>
      <h4 class="text-muted mt-3">No hay productos registrados</h4>
      <p class="text-muted">Comienza agregando el primer producto al catálogo</p>
      <a th:href="@{/productos/new}" class="btn btn-success">
        <i class="bi bi-plus-circle me-2"></i>Crear Primer Producto
      </a>
    </div>
  </div>

</section>

</html>